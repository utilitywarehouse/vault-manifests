apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: vault
spec:
  template:
    spec:
      initContainers:
        - name: plugin-installer
          image: alpine
          restartPolicy: Always
          command:
            - /bin/sh
            - -c
            - |
              apk update
              apk add --no-cache curl

              cd /tmp

              VERSION=2.3.0
              DEST="/vault/plugins/vault-plugin-secrets-github"

              curl -Ls "https://github.com/martinbaillie/vault-plugin-secrets-github/releases/download/v${VERSION}/vault-plugin-secrets-github-linux-amd64" \
                > ${DEST}
              chmod +x "${DEST}"

              SHA256_HASH=$(sha256sum "${DEST}" | cut -d ' ' -f 1)
              echo "The SHA256 hash of ${DEST} is: ${SHA256_HASH}"
          volumeMounts:
            - name: plugins
              mountPath: /vault/plugins
      containers:
        - name: vault
          volumeMounts:
            - name: plugins
              mountPath: /vault/plugins
      volumes:
        - name: plugins
          emptyDir: {}
